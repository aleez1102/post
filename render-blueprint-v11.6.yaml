services:
  # ------------------------------
  # REWRITE PREPROCESSOR SERVICE
  # ------------------------------
  - type: web
    name: rewrite-preprocessor-ms
    env: docker
    region: oregon
    plan: free
    branch: main
    rootDir: rewrite-ms
    dockerfilePath: Dockerfile
    buildCommand: ""
    startCommand: "node index.js"
    autoDeploy: true
    envVars:
      - key: SERVICE_NAME
        value: rewrite-preprocessor
      - key: API_KEY
        sync: false
    healthCheckPath: /health

  # ------------------------------
  # INTERNAL LINK ENGINE
  # ------------------------------
  - type: web
    name: internal-link-engine-ms
    env: docker
    region: oregon
    plan: free
    branch: main
    rootDir: internal-link-ms
    dockerfilePath: Dockerfile
    startCommand: "node index.js"
    autoDeploy: true
    envVars:
      - key: SERVICE_NAME
        value: internal-link-engine
    healthCheckPath: /health

  # ------------------------------
  # PREDICTION ENGINE
  # ------------------------------
  - type: web
    name: prediction-engine-ms
    env: docker
    region: oregon
    plan: free
    rootDir: prediction-ms
    dockerfilePath: Dockerfile
    startCommand: "node server.js"
    autoDeploy: true
    envVars:
      - key: SERVICE_NAME
        value: prediction-engine
      - key: OPENAI_API_KEY
        sync: false
    healthCheckPath: /health

  # ------------------------------
  # DB ROTATION SERVICE
  # ------------------------------
  - type: worker
    name: db-rotation-worker-ms
    env: docker
    region: oregon
    plan: free
    rootDir: db-rotation-ms
    dockerfilePath: Dockerfile
    startCommand: "node rotate.js"
    autoDeploy: true
    envVars:
      - key: CRON_SCHEDULE
        value: "0 */6 * * *"   # every 6 hours
    healthCheckPath: /health

  # ------------------------------
  # TTS PROXY MICROSERVICE
  # ------------------------------
  - type: web
    name: tts-proxy-ms
    env: docker
    region: oregon
    plan: free
    rootDir: tts-proxy-ms
    dockerfilePath: Dockerfile
    startCommand: "python3 app.py"
    autoDeploy: true
    envVars:
      - key: TTS_PROVIDER
        value: openai
      - key: OPENAI_API_KEY
        sync: false
    healthCheckPath: /health

# ------------------------------
# GLOBAL ENV LINKS (Orchestrator)
# ------------------------------
envVarGroups:
  - name: orchestrator-microservices
    envVars:
      - key: REWRITE_MICROSERVICE_URL
        value: https://rewrite-preprocessor-ms.onrender.com
      - key: INTERNAL_LINKING_MICRO_URL
        value: https://internal-link-engine-ms.onrender.com
      - key: PREDICTION_ENGINE_URL
        value: https://prediction-engine-ms.onrender.com
      - key: DB_ROTATION_MICRO_URL
        value: https://db-rotation-worker-ms.onrender.com
      - key: TTS_MICRO_URL
        value: https://tts-proxy-ms.onrender.com
